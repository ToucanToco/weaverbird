<template>
  <div class="filter-form" data-cy="weaverbirder-filter-step-form">
    <StepFormHeader
      :title="title"
      :stepName="editedStep.name"
      :version="version"
      :backendError="backendError"
    />
    <div class="filter-form__info">Filter rows matching this condition:</div>
    <FilterEditor
      :filter-tree="editedStep.condition"
      :errors="errors"
      :available-variables="availableVariables"
      :variable-delimiters="variableDelimiters"
      :trusted-variable-delimiters="trustedVariableDelimiters"
      :columnTypes="columnTypes"
      @filterTreeUpdated="updateFilterTree"
    />
    <StepFormButtonbar />
  </div>
</template>

<script lang="ts">
import Component from 'vue-class-component';
import { Prop } from 'vue-property-decorator';

import FilterEditor from '@/components/FilterEditor.vue';
import type { ColumnTypeMapping } from '@/lib/dataset';
import type {
  FilterCondition,
  FilterSimpleCondition,
  FilterStep,
  PipelineStepName,
} from '@/lib/steps';
import type { VariableDelimiters, VariablesBucket } from '@/lib/variables';
import { VQBModule } from '@/store';
import { State, Getter } from 'pinia-class';

import BaseStepForm from './StepForm.vue';

@Component({
  name: 'filter-step-form',
  components: {
    FilterEditor,
  },
})
export default class FilterStepForm extends BaseStepForm<FilterStep> {
  stepname: PipelineStepName = 'filter';

  @Prop({
    type: Object,
    default: () => ({
      name: 'filter',
      condition: { column: '', value: '', operator: 'eq' },
    }),
  })
  declare initialStepValue: FilterStep;

  @State(VQBModule) availableVariables?: VariablesBucket;
  @State(VQBModule) variableDelimiters?: VariableDelimiters;
  @State(VQBModule) trustedVariableDelimiters?: VariableDelimiters;

  @Getter(VQBModule) columnTypes!: ColumnTypeMapping;

  readonly title: string = 'Filter';

  created() {
    // On creation, if a column is selected, use it to set "column" property of
    // the filter step
    if (this.isStepCreation && this.selectedColumns[0]) {
      const condition = { column: this.selectedColumns[0], value: '', operator: 'eq' };
      this.editedStep = {
        name: 'filter' as 'filter',
        condition: condition as FilterSimpleCondition,
      };
    } else {
      // Otherwise, fallback on the default initial value
      this.editedStep = {
        name: 'filter' as 'filter',
        condition: { ...this.initialStepValue.condition },
      };
    }
  }

  submit() {
    this.$$super.submit();
  }

  updateFilterTree(newFilterTree: FilterCondition) {
    this.editedStep = {
      name: 'filter',
      condition: newFilterTree,
    };
  }
}
</script>

<style lang="scss" scoped>
.filter-form-headers__container {
  display: flex;
  width: 66%;
}

.filter-form-header {
  font-size: 14px;
  margin-left: 10px;
  width: 50%;
}
</style>
<style lang="scss">
.filter-form {
  .widget-list__body .widget-list__icon {
    top: 5px;
  }
  .widget-list__component-sep {
    left: 0;
    position: absolute;
    top: 10px;
  }
}
.filter-form--multiple-conditions {
  .filter-form-headers__container {
    margin-left: 30px;
  }
  .widget-list__component {
    margin-left: 30px;
  }
}
</style>
