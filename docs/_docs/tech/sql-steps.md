---
title: SQL Steps
permalink: /docs/steps/sql/
---

## Steps definition

This document describes the steps that can be used in our SQL Translator pipeline. A step is
the unit of transformation generated by a user interaction with the SQL visual query
builder.

## Implementation logic 

The steps were implemented using the following concepts: 
- A step is named following this convention: **<OPERATION_NAME>\_STEP\_<STEP_INDEX>**
- A pipeline starts with a select step using the query provided by the user like below
```
WITH SELECT_STEP_0 AS (<USER'S QUERY STRING>)
```
- Each step concatenates the resulting query string it generates to the query string received in input
For example, a *SelectStep* followed by a *FilterStep* results in
```
WITH SELECT_STEP_0 AS (<USER'S QUERY STRING>),
FILTER_STEP_1 AS (SELECT * FROM SELECT_STEP_0 WHERE PRICE > 10)
```
- Each step updates the final **selection query** with its name
For example, the query string sent to the data provider for a *SelectStep* followed by a *FilterStep* would be
```
WITH SELECT_STEP_0 AS (<USER'S QUERY STRING>),
FILTER_STEP_1 AS (SELECT * FROM SELECT_STEP_0 WHERE PRICE > 10)
SELECT * FROM FILTER_STEP_1
```

### `filter` step

Filter out lines that match or don't match a filter definition.

```javascript
{
    name: 'filter',
    condition: {
      column: 'my-column',
      value: 42,
      operator: 'ne'
    }
}
```
For example this step would generate a query like this: 

```
FILTER_STEP_1 AS (SELECT * FROM SELECT_STEP_0 WHERE my-column != 42)
```


`operator` is optional, and defaults to `eq`. Allowed operators are `eq`, `ne`,
`gt`, `ge`, `lt`, `le`, `in`, `nin`, `matches`, `notmatches` `isnull` or `notnull`.

`value` can be an arbitrary value depending on the selected operator (e.g a list
when used with the `in` operator, or `null` when used with the `isnull`
operator).

`matches` and `notmatches` operators are used to test value against a regular expression.

Conditions can be grouped and nested with logical operators `and` and `or`.

```javascript
{
    name: 'filter',
    condition: {
      and: [
        {
          column: 'my-column',
          value: 42,
          operator: 'gte'
        },
        {
          column: 'my-column',
          value: 118,
          operator: 'lte'
        },
        {
          or: [
            {
              column: 'my-other-column',
              value: 'blue',
              operator: 'eq'
            },
            {
              column: 'my-other-column',
              value: 'red',
              operator: 'eq'
            }
          ]
        }
      ]
    }
}
```




### `aggregate` step 
Perform aggregations on one or several columns. Available aggregation functions
are sum, average, count, count distinct, min, max, first, last.

An aggregation step has the following structure:

```javascript
{
   name: 'aggregate',
   on: ['column1'],
   aggregations:  [
    {
      newcolumns: ['sum_value1'],
      aggfunction: 'sum',
      columns: ['value1']
    }
    {
      newcolumns: ['avg_value1'],
      aggfunction: 'avg',
      columns: ['value1']
    }
  ]
}
```

`AVG, SUM, MAX, MIN, COUNT, COUNT DISTINCT` Generates fairly simple queries (with or without `group by` columns) such as:

```
WITH SELECT_STEP_0 AS (SELECT * FROM "TPCH_SF1"."CUSTOMER" limit 1000),
AGGREGATE_STEP_1 AS (SELECT SUM(value1) AS sum_value1, column1 FROM SELECT_STEP_0 GROUP BY column1)
SELECT * FROM AGGREGATE_STEP_1;
```

The case of `FIRST` and `LAST` are much more tricky. For both we rely on `ROW_COUNT()` function which is a **window function**. 
The translator as many cases to handle when performing this aggregation: 
- `FIRST/LAST` without `GROUP BY` without other aggregations

```javascript
{
   name: 'aggregate',
   aggregations:  [
    {
      newcolumns: ['first_value2'],
      aggfunction: 'first',
      columns: ['value2']
    }
  ]
}
```
Generates this query: 
```
WITH SELECT_STEP_0 AS (<USER'S QUERY>),
AGGREGATE_STEP_1 AS (SELECT first_value2 FROM (SELECT value2 AS first_value2, ROW_NUMBER() OVER (ORDER BY value2) AS R FROM SELECT_STEP_0 QUALIFY R = 1)) 
SELECT * FROM AGGREGATE_STEP_1
```
- `FIRST/LAST` with a `GROUP BY` without other aggregations

```javascript
{
   name: 'aggregate',
   on: ['column1'],
   aggregations:  [
    {
      newcolumns: ['first_value2'],
      aggfunction: 'first',
      columns: ['value2']
    }
  ]
}
```
Generates this query: 
```
WITH SELECT_STEP_0 AS (<USER'S QUERY>),
AGGREGATE_STEP_1 AS (SELECT first_value2 FROM (SELECT value2 AS first_value2, column1, ROW_NUMBER() OVER (PARTITION BY column1 ORDER BY value2) AS R FROM SELECT_STEP_0 QUALIFY R = 1)) 
SELECT * FROM AGGREGATE_STEP_1
```

- `FIRST/LAST` without `GROUP BY` with another aggregation

```javascript
{
   name: 'aggregate',
   aggregations:  [
    {
      newcolumns: ['sum_value1'],
      aggfunction: 'sum',
      columns: ['value1']
    }
    {
      newcolumns: ['first_value2'],
      aggfunction: 'first',
      columns: ['value2']
    }
  ]
}
```
Generates this query:
```
WITH SELECT_STEP_0 AS (<USER'S QUERY>),
AGGREGATE_STEP_1 AS (SELECT A.*, F.first_value2 FROM (SELECT SUM(value1) AS sum_value1 FROM SELECT_STEP_0) A
INNER JOIN (SELECT value2 FROM (SELECT value2 AS first_value2, ROW_NUMBER() OVER (ORDER BY value2) AS R FROM SELECT_STEP_0 QUALIFY R = 1)) F) SELECT * FROM AGGREGATE_STEP_1
```


- `FIRST/LAST` with `GROUP BY` with another aggregation

```javascript
{
   name: 'aggregate',
   on: ['column1'],
   aggregations:  [
    {
      newcolumns: ['sum_value1'],
      aggfunction: 'sum',
      columns: ['value1']
    }
    {
      newcolumns: ['first_value2'],
      aggfunction: 'first',
      columns: ['value2']
    }
  ]
}
```
Generates this query: 
```
WITH SELECT_STEP_0 AS (<USER'S QUERY>),
AGGREGATE_STEP_1 AS (SELECT A.*, F.first_value2 FROM (SELECT SUM(value1) AS sum_value1 FROM SELECT_STEP_0 GROUP BY column1) A
INNER JOIN (SELECT value2 FROM (SELECT value2 AS first_value2, column1, ROW_NUMBER() OVER (PARTITION BY column1 ORDER BY value2) AS R FROM SELECT_STEP_0 QUALIFY R = 1)) F)  ON
A.column1 = F.column1
SELECT * FROM AGGREGATE_STEP_1
```
